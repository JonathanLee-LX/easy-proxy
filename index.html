<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Proxy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        .status-2xx { color: #059669; font-weight: 500; }
        .status-3xx { color: #d97706; font-weight: 500; }
        .status-4xx { color: #ea580c; font-weight: 500; }
        .status-5xx { color: #dc2626; font-weight: 500; }
    </style>
</head>

<body class="min-h-screen bg-slate-100">
    <div id="App" class="min-h-screen flex justify-center items-start p-4 md:p-6">
        <div class="w-full max-w-6xl bg-white rounded-xl shadow-lg overflow-hidden flex flex-col min-h-[90vh]">
            <!-- Tabs -->
            <div class="flex border-b border-slate-200 bg-slate-50/50" v-scope="AppCard()">
                <button
                    v-for="tab in store.tabs"
                    @click="onTabChange(tab.key)"
                    :class="[
                        'flex-1 py-4 px-6 text-base font-medium transition-colors',
                        store.activeTab === tab.key
                            ? 'bg-white text-slate-900 border-b-2 border-slate-900 -mb-px'
                            : 'text-slate-500 hover:text-slate-700 hover:bg-slate-100'
                    ]"
                >
                    <span v-text="tab.title"></span>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Config Tab -->
                <div v-if="store.activeTab === 'config'" v-scope class="space-y-4" v-effect="fetchData()">
                    <ul class="space-y-3">
                        <li v-for="(item, i) in rules" class="flex items-center gap-3 p-3 rounded-lg bg-slate-50 hover:bg-slate-100 transition-colors">
                            <input type="checkbox" v-model="item.enabled" class="w-5 h-5 rounded border-slate-300 text-slate-900 focus:ring-slate-500">
                            <input type="text" v-model="item.rule" placeholder="规则" class="flex-1 px-3 py-2 rounded-md border border-slate-300 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 text-sm">
                            <input type="text" v-model="item.target" placeholder="目标" class="flex-1 px-3 py-2 rounded-md border border-slate-300 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 text-sm">
                            <button @click="onDelete(i)" class="px-3 py-2 text-sm font-medium text-red-600 hover:text-red-700 hover:bg-red-50 rounded-md transition-colors">删除</button>
                        </li>
                    </ul>
                    <div class="flex gap-3 pt-4 sticky bottom-0 bg-white border-t border-slate-200 pt-4 -mx-6 px-6 -mb-6 pb-6">
                        <button @click="onSubmit" class="flex-1 py-2.5 px-4 bg-slate-900 text-white font-medium rounded-lg hover:bg-slate-800 transition-colors">保存</button>
                        <button @click="onAdd" class="flex-1 py-2.5 px-4 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-500 transition-colors">添加</button>
                    </div>
                </div>

                <!-- Log Tab -->
                <div v-else-if="store.activeTab === 'log'" v-scope="RecordList({recordList: store.recordList})"></div>
            </div>
        </div>

        <!-- Detail Panel -->
        <div
            class="fixed right-0 top-0 w-full max-w-lg h-full bg-white shadow-2xl flex flex-col z-50 transition-transform duration-200 ease-out"
            :class="{ 'translate-x-full pointer-events-none': store.selectedRecordId == null }"
            v-scope="DetailPanel()"
        >
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-slate-50">
                <span class="font-semibold text-slate-900">请求详情 #{{ store.selectedRecordId }}</span>
                <button @click="store.selectedRecordId = null; store.recordDetail = null" class="px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-200 rounded-md transition-colors">关闭</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6" v-if="store.recordDetail">
                <div class="space-y-5">
                    <div>
                        <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">状态码</h4>
                        <div :class="['px-3 py-2 rounded-lg bg-slate-50 font-mono text-sm', 'status-' + String(store.recordDetail.statusCode)[0] + 'xx']">
                            {{ store.recordDetail.statusCode }} {{ store.recordDetail.statusMessage || '' }}
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">请求头</h4>
                        <pre class="px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 font-mono text-xs overflow-x-auto max-h-40 overflow-y-auto">{{ store.formatHeaders(store.recordDetail.requestHeaders) }}</pre>
                    </div>
                    <div>
                        <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">请求体</h4>
                        <pre class="px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 font-mono text-xs whitespace-pre-wrap break-all max-h-48 overflow-y-auto">{{ store.recordDetail.requestBody || '(空)' }}</pre>
                    </div>
                    <div>
                        <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">响应头</h4>
                        <pre class="px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 font-mono text-xs overflow-x-auto max-h-40 overflow-y-auto">{{ store.formatHeaders(store.recordDetail.responseHeaders) }}</pre>
                    </div>
                    <div>
                        <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">响应体</h4>
                        <pre class="px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 font-mono text-xs whitespace-pre-wrap break-all max-h-48 overflow-y-auto">{{ store.recordDetail.responseBody || '(空)' }}</pre>
                    </div>
                </div>
            </div>
            <div class="flex-1 flex items-center justify-center text-slate-400" v-else>加载中...</div>
        </div>
    </div>

    <template id="record-list">
        <div class="space-y-4">
            <input
                type="text"
                placeholder="过滤源地址..."
                v-model="store.filterValue"
                class="w-full max-w-md px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 text-sm"
            >
            <div class="rounded-lg border border-slate-200 overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-slate-600">#</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-600">方法</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-600">源地址</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-600">目标地址</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-600">时间</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-600 w-20">操作</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr
                            v-for="(item, i) in recordList.filter(item => store.filterValue ? item.source.includes(store.filterValue) : true)"
                            :class="[
                                'transition-colors',
                                item.id != null ? 'cursor-pointer hover:bg-slate-50' : ''
                            ]"
                            @click="item.id != null && __epStore.openDetail(item.id)"
                        >
                            <td class="px-4 py-3 text-slate-500 font-mono">{{ i }}</td>
                            <td class="px-4 py-3">
                                <span class="font-semibold text-emerald-600">{{ item.method }}</span>
                            </td>
                            <td class="px-4 py-3 max-w-xs truncate">
                                <a :href="item.source" target="_blank" @click.stop class="text-slate-600 hover:text-slate-900 hover:underline truncate block">{{ item.source }}</a>
                            </td>
                            <td class="px-4 py-3 max-w-xs truncate">
                                <a :href="item.target" target="_blank" @click.stop class="text-slate-600 hover:text-slate-900 hover:underline truncate block">{{ item.target }}</a>
                            </td>
                            <td class="px-4 py-3 text-slate-500 text-xs">{{ item.time }}</td>
                            <td class="px-4 py-3">
                                <button v-if="item.id != null" type="button" :data-id="item.id" class="px-2 py-1 text-xs font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded transition-colors" onclick="var id=parseInt(this.dataset.id,10);if(!isNaN(id))window.__epStore.openDetail(id)">查看</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </template>

    <script type="module">
        import { createApp, reactive } from 'https://unpkg.com/petite-vue?module'

        const store = reactive({
            recordList: [],
            tabs: [
                { title: '规则配置', key: 'config' },
                { title: '日志', key: 'log' }
            ],
            activeTab: 'config',
            filterValue: '',
            selectedRecordId: null,
            recordDetail: null,
            formatHeaders(headers) {
                if (!headers) return '(空)'
                return Object.entries(headers).map(([k, v]) => k + ': ' + v).join('\n')
            },
            async fetchDetail(id) {
                this.recordDetail = null
                const res = await fetch('/api/logs/' + id)
                const data = await res.json()
                this.recordDetail = data.error ? null : data
            },
            openDetail(id) {
                this.selectedRecordId = id
                this.fetchDetail(id)
            }
        })

        fetch('/api/logs').then(res => res.json()).then((json) => store.recordList.push(...json))

        window.__epStore = store

        // WebSocket with reconnection
        let ws = null
        let reconnectTimeout = null
        let reconnectAttempts = 0
        const MAX_RECONNECT_ATTEMPTS = 10
        const BASE_RECONNECT_DELAY = 1000

        const connectWebSocket = () => {
            const protocol = location.protocol === "https:" ? "wss://" : "ws://";
            ws = new WebSocket(protocol + location.host + location.pathname)

            ws.addEventListener('error', (ev) => {
                console.error('WebSocket error:', ev)
            })

            ws.addEventListener('close', () => {
                console.log('WebSocket closed')
                ws = null

                // Exponential backoff reconnection
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    const delay = Math.min(BASE_RECONNECT_DELAY * Math.pow(2, reconnectAttempts), 30000)
                    console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts + 1}/${MAX_RECONNECT_ATTEMPTS})`)
                    reconnectTimeout = setTimeout(() => {
                        reconnectAttempts++
                        connectWebSocket()
                    }, delay)
                } else {
                    console.error('Max reconnection attempts reached')
                }
            })

            ws.addEventListener('open', () => {
                console.log('WebSocket connected')
                reconnectAttempts = 0 // Reset on successful connection
            })

            ws.addEventListener('message', (ev) => {
                try {
                    const data = JSON.parse(ev.data)
                    store.recordList.push(data)
                } catch (e) {
                    console.error('Failed to parse WebSocket message:', e)
                }
            })
        }

        connectWebSocket()

        function RecordList(props) {
            return {
                $template: '#record-list',
                recordList: props.recordList,
                store
            }
        }

        function DetailPanel() {
            return { store }
        }

        function AppCard() {
            return { store, onTabChange: (key) => { store.activeTab = key } }
        }

        const app = createApp({
            RecordList,
            DetailPanel,
            AppCard,
            store,
            onAdd() {
                this.rules.push({
                    enabled: true,
                    rule: '',
                    target: ''
                })
            },
            onDelete(index) {
                this.rules.splice(index, 1)
            },
            onTabChange(key) {
                store.activeTab = key
            },
            onSubmit() {
                fetch('/api/rules', {
                    method: 'PUT',
                    body: this.rules.reduce((text, rule) => {
                        text += rule.enabled ? '' : '//'
                        text += rule.rule + ' ' + rule.target
                        text += '\n'
                        return text
                    }, '')
                }).then(res => res.json()).then(json => {
                    console.log('save success!!')
                    console.log(json)
                }).catch(err => console.error('save failed ', err))
            },
            rules: [],
            fetchData() {
                const IP_PATTERN = /^\d+\.\d+\.\d+\.\d+(:\d+)?$/
                const URL_PATTERN = /^https?:\/\//
                fetch('api/rules').then(res => res.text()).then(text => {
                    this.rules = text.split(/\r?\n/).filter(line => line.trim()).flatMap(line => {
                        let enabled = true
                        if (line.trimStart().startsWith('//')) {
                            enabled = false
                            line = line.replace(/^\/\//, '').trim()
                        }
                        const parts = line.split(/\s+/).filter(Boolean)
                        if (parts.length < 2) return []
                        const isTargetFirst = IP_PATTERN.test(parts[0]) || URL_PATTERN.test(parts[0])
                        if (isTargetFirst) {
                            const [target, ...rules] = parts
                            return rules.map(rule => ({ rule, target, enabled }))
                        } else {
                            const target = parts[parts.length - 1]
                            const rules = parts.slice(0, -1)
                            return rules.map(rule => ({ rule, target, enabled }))
                        }
                    })
                })
            },
        }).mount('#App')
    </script>
</body>

</html>
